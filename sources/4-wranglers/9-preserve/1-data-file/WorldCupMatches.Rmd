---
pagetitle: "Kamino"
output: 
  html_document:
    theme: lumen
    css: "../../../z-assemblers/assets/styles/content.css"
    df_print: paged
    mathjax: NULL
    code_folding: show
    include:
      in_header: "../../../z-assemblers/fragments/header.html"
      after_body: "../../../z-assemblers/fragments/footer.html"
    self_contained: false
    lib_dir: "vendor"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=FALSE)
options(scipen=999)  # turn-off scientific notation like 1e+48

# Clear environment and memory
rm(list = ls(all.names = TRUE)) #will clear all objects includes hidden objects.
gc() #free up memory and report the memory usage.

library(tidyverse)
library(ggiraph)

library(knitcitations)
library(bibtex)
library(tidyverse)
library(dplyr)

library("sf")
library("rnaturalearth")
library("scales")
library("ggrepel")
library("readr")

library(showtext)
## Loading Google fonts (https://fonts.google.com/)
font_add_google("Inconsolata", "inconsolata")
# turn on showtext
showtext_auto()
```

<div class="activity">
WRANGLERS  
</div>

# World Cup!!!
## Store

```{r, out.width="60%", fig.align="center", fig.cap="Photo by Fauzan Saari on Unsplash"}

masthead <- "assets/fauzan-saari-AmhdN68wjPc-unsplash.jpg"
knitr::include_graphics(masthead, dpi=72)

```

<div class="figure-text">World Cup Trophy</div>


> The only way to win is as a team...\
--- Pele\


***

### Load Data
```{r load raw data,  message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-hide'}
df_world_cup <- read_csv("./archetypes/WorldCupMatches.csv")
df_world_cup
#str(df_world_cup)
#head(df_world_cup)
#tail(df_world_cup)
```

### Prepare the data
#### Remove Missing Value
```{r method: clean, message=FALSE, echo=TRUE,warning=FALSE}

#df_world_cup1 <- na.omit(df_world_cup)

df_world_cup1 <- df_world_cup[!is.na(df_world_cup$Year),]

#df_world_cup1A <- df_world_cup1[!is.na(df_world_cup1$`Home Team Name`),]

df_world_cup1

```

#### Replace Values (Replace Home Team Names _Germany FR_ to _Germany_)

```{r method: find, message=FALSE, echo=TRUE,warning=FALSE}
df_world_cup1 %>% filter(str_detect(`Home Team Name`, "^Germany"))

```

```{r method: replace, message=FALSE, echo=TRUE,warning=FALSE}
df_world_cup2 <- df_world_cup1


df_world_cup2$`Home Team Name` <- replace(df_world_cup2$`Home Team Name`, df_world_cup2$`Home Team Name`=="Germany FR","Germany" )

df_world_cup2

```

#### Select only meaningful columns
```{r method: select, message=FALSE, echo=TRUE,warning=FALSE}

df_world_cup3 <- df_world_cup2

#df_world_cup3 <- df_world_cup3[,c(1,5:9,14)]

df_world_cup3 <- df_world_cup3 %>% select(Year,`Home Team Name`, `Home Team Goals`,`Away Team Goals`, `Away Team Name`, `Referee`)

df_world_cup3

```

#### Rename meaningful columns
```{r method: rename, message=FALSE, echo=TRUE,warning=FALSE}

df_world_cup4 <- df_world_cup3

df_world_cup4 <- df_world_cup4 %>% rename(Home_Team='Home Team Name', Away_Team='Away Team Name', Home_Team_Goals='Home Team Goals', Away_Team_Goals='Away Team Goals')

#head(df_world_cup4)
df_world_cup4


```

### Reduce data
#### Filter data - Home_team is Brazil & Away_Team is Germany

```{r method: filter, message=FALSE, echo=TRUE,warning=FALSE}

df_world_cup5 <- df_world_cup4

df_world_cup5 <- df_world_cup5 %>% filter((Home_Team=="Brazil") & (Away_Team=="Germany"))

df_world_cup5
```


#### Filter data - It is OK for Home Teams to Lose! :-()
#### Filter all countries that have lost at home

```{r method: an, message=FALSE, echo=TRUE,warning=FALSE}
df_world_cup6 <- df_world_cup4

df_world_cup6 <- df_world_cup6 %>% filter(Home_Team_Goals<Away_Team_Goals)

df_world_cup6 
#df_world_cup6 %>% filter(str_detect(`Home_Team`, "^Germany"))
#df_world_cup6 %>% filter(str_detect(`Home_Team`, "^Brazil"))
```

### Extend data
#### Group data - how many goals taken by home team 


```{r method: cl, message=FALSE, echo=TRUE,warning=FALSE}

df_world_cup7 <- df_world_cup6

df_world_cup7 <- df_world_cup7 %>% group_by(Home_Team) %>% 
                                   summarise(Total_Goals_Taken = sum(Away_Team_Goals), Number_Games = n())

df_world_cup7
```


### Sort - Not Sore Losers!
#### Do you know why these are the countries that have lost more?

```{r method: clan, message=FALSE, echo=TRUE,warning=FALSE}
df_world_cup8 <- df_world_cup7

df_world_cup8 <- df_world_cup8 %>% arrange(desc(Total_Goals_Taken))
#df_world_cup8 <- df_world_cup8 %>% arrange(desc(Number_Games))

df_world_cup8

```

###  Plot

```{r load rw data,  message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-hide', fig.width= 1920/72, fig.height = 1080/72, out.width = "100%"}

# For the first 20 countries
df_world_cup9 <- df_world_cup8[1:20,]

v1 <- ggplot(df_world_cup9, aes(x=reorder(Home_Team, Total_Goals_Taken), y=Total_Goals_Taken))+
  geom_bar(stat="identity", fill="steelblue") +
  coord_flip() + 
  scale_y_continuous(labels = comma) +
  labs(y="Number of Goals Taken", x="Home Team")+ 
  ggtitle("Total of Goals Taken by Home Teams (1930-2014)")

girafe(ggobj = v1, width_svg = 1280/72, height_svg = 720/72, options =
list(opts_sizing(rescale = TRUE, width = 1.0)))
```

###  Preserve
#### Storing and Saving your outputs

### Updated data to a csv file
```{r method: cgglan, message=FALSE, echo=TRUE,warning=FALSE}
#Save the last file created
write.csv(df_world_cup8, './output/world_cup_1930-2014.csv')

```

### Saving the graph
```{r method: claaan, message=FALSE, echo=TRUE,warning=FALSE}
ggsave(file="./output/world_cup_1930-2014.svg", plot=v1, width=12, height=8)
```

### As reusable solution
```{r eval=FALSE, echo=TRUE, message=FALSE, include=TRUE}
####################################################################################
# Required libraries
library(ggplot2)

####################################################################################
# Write a dataset to a .csv file
f_write_csv <- function(df_write_csv, path) {
  write.csv(df_write_csv, paste(getwd(), path,sep="/"))
}

# Call the function 
f_write_csv(df, "test.csv")
####################################################################################


####################################################################################
# Save an plot from R Session
f_save_img <- function(path, df_plot) {
  ggsave(filename= paste(path), plot=df_plot, scale=1, width=11, height=11, units="in")
}


# Call the function 
f_save_img("testing.png", x)
####################################################################################


####################################################################################
# Save the last plot from R Session
f_save_img <- function(path) {
  ggsave(filename= paste(path), plot=last_plot(), scale=1, width=11, height=11, units="in")
}


# Call the function 
f_save_img("test 2.svg") #Put any image extensions in file name (eg. jpg and svg)
####################################################################################

```


# References
## The citations and data sources used for this case can be found be found on the Fifa World Cup data on <a href="https://www.kaggle.com/abecklas/fifa-world-cup" target="_blank"> Kaggle. </a>

```{r generateBibliography, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}

# cleanbib()
options("citation_format" = "pandoc")
read.bibtex(file = "./citations/WorldCupMatches.bib")


```


```{r, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE, class.source='fold-hide'}

# eval = FALSE as default; run manually as chunk

# ENTER METADATA
# Use space to separate keywords or "-" for phrases
methods <- "Store" # mostly used in wranglers and analytics
keywords <- 'football world-cup'
commands <- 'write.csv ggsave'
sources <- 'Kaggle'

# CREATE METADATA
source("../../../z-scripts/create_metadata.R", local = knitr::knit_global())

# RUN PRODUCTION OUTPUTS
source("../../../z-scripts/create_production_output.R", local = knitr::knit_global())


```


```{js, message=FALSE, warning=FALSE, echo=FALSE}

// Must be included to position footer
$(function() {
  $('.main-container').after($('.footer'));
})

```

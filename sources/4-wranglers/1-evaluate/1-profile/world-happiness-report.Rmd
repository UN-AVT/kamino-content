---
pagetitle: "Kamino"
output: 
  html_document:
    theme: lumen
    css: "../../../z-assemblers/assets/styles/content.css"
    df_print: paged
    mathjax: NULL
    code_folding: show
    include:
      in_header: "../../../z-assemblers/fragments/header.html"
      after_body: "../../../z-assemblers/fragments/footer.html"
    self_contained: false
    lib_dir: "vendor"
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=FALSE)
options(scipen=999)  # turn-off scientific notation like 1e+48

# Clear environment and memory
rm(list = ls(all.names = TRUE)) #will clear all objects includes hidden objects.
gc() #free up memory and report the memory usage.

library(tidyverse)
library(dplyr)
library(readxl)
library(ggiraph)

library(kableExtra)
library(knitcitations)
library(bibtex)

library(showtext)
## Loading Google fonts (https://fonts.google.com/)
font_add_google("Inconsolata", "inconsolata")
# turn on showtext
showtext_auto()


```

<div class="activity">
WRANGLERS  
</div>

# Which Countries are the Happiest?
## Profiling

```{r, out.width="60%", fig.align="center", fig.cap="Photo by Alex Alvarez on Unsplash"}

masthead <- "assets/happypeople.jpg"
knitr::include_graphics(masthead, dpi=72)

```

<div class="figure-text">World Happiness Report</div>

> The World Happiness Report has proven to be an indispensable tool for policymakers \
looking to better understand what makes people happy...\
--- Jeffrey Sachs

***

### Load the data
```{r load-data, message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-hide'}

df <- read_xls('./archetypes/happiness-report/happiness-report-2020.xls')
df
```

#### Looks like there is a lot of information collected in this data. Let's go step by step:

#### Find the dimensions of our data: number of columns and rows

```{r message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-show'}
dim(df)

```

#### The above results tell us that the data contains 1704 rows, and 26 columns.

### List keys and column types

#### Let's learn more about what is included in each column, and what type data is recorded.

```{r message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-show'}
glimpse(df)

```

The above provides a little more information. For example, we see that 'Country name' is a column of characters __char__, and that all other columns are numbers __dbl__. This is useful because we can already guess that 'Year' does not have the right type. It should not be treated as a number. We will fix it with the next command. Also notice the beginning values of each column; this is useful to get familiar with the data on hand. Some columns display a lot of NA, which indicates the absence of data.

```{r message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-show'}
df <- df %>% mutate(Year = as.factor(Year))
str(df$Year)
```

#### Column 'Year' is now a datatype called factor, which is a type of categorical variables in R. Levels are the possible values in the factor.


```{r message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-show'}
glimpse(df)
```

### Value missing

#### For each column, we now list the number of missing values.

```{r message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-show'}

missing_stats <- purrr::map_df(df, ~ sum(is.na(.))) %>%
  gather('Column name', 'Count of missing values')

missing_stats
```

#### We now know that the first 3 Columns are not missing any value, but 'Log GDP per capita' has 28 missing values.

### Value distinct

#### It will also be interesting to check how many distinct Countries, and how many distinct Years are present in this dataset. The numerical columns are not of much interest here.

#### Firstly, for Country Name:

```{r message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-show'}

distinct_df <- distinct(df,`Country name`) %>% arrange(`Country name`)
distinct_df

```


#### Then Year:

```{r message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-show'}
distinct_df <- distinct(df, Year) %>% arrange(Year)
distinct_df
```


### Frequency
#### Let's count the absolute frequency for a categorical variable: "Year", and the relative frequency as well.

```{r message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-show'}
df_1= table(df$Year)
df_2 <- as.data.frame(df_1) %>% 
  dplyr::rename(Year = Var1, Freq_absolute = Freq) %>% 
  mutate(Freq_relative=paste0(round(100*Freq_absolute/sum(Freq_absolute),digits=2),"%"))
df_2
```


#### So for example, for year 2008, we have 110 records, which represents about 6.5% of the entire dataset.

### Value positive, negative and zero

#### For all the numerical columns in the dataset, let's find out how many positive, negative and zero values they have.

```{r message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-show'}
df1 <- df[,3:ncol(df)]

nRows <- dim(df1)[1]

calcStats <- function(x) {
  temp <- na.omit(df[, x])
  pos <- sum(temp > 0)
  is_zero <- sum(temp = 0)
  neg <-  sum(temp < 0)
  c("number of positives" = pos, "negatives" = neg, "zero" = is_zero)
}
  
result <- as.data.frame(Map(calcStats, colnames(df1)))
result
```



### Review Histograms of numerical variable

#### Lastly, it is a good idea to review the range of values for each numerical variable in our dataset. Histograms come handy:

```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source ='fold-hide', fig.width=1920/72, fig.height=1080/72, out.width="100%"}

df_long <- df %>%
  pivot_longer(
    `Life Ladder`:`Most people can be trusted, WVS round 2010-2014`,
    names_to = "measure",
    values_to = "value"
  )

v1 <- ggplot(df_long, aes(x=value)) +
  geom_histogram(fill = "#79B8E5") +
 facet_wrap(~ measure, scales="free")+
  theme(panel.grid = element_blank(), 
        strip.background = element_blank(),
       panel.background = element_blank()
 ) 

girafe(ggobj = v1, width_svg = 1280/72, height_svg = 720/72, options =
list(opts_sizing(rescale = TRUE, width = 1.0)))

 
```


### Save plot
#### as vector or raster image


```{r, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE, class.source='fold-show'}

# eval = FALSE as default; run manually as chunk

# full version
ggsave(filename = "outputs/world_hapiness.svg", plot = v1, width=1280/72, height=720/72)

```

#### As we will see later in the course, the two variables of interest will be "Life Ladder" and "Log GDP per capita". Just looking at the graph, we see that the "Life Ladder" varies from 0 to 8, with the majority of values between 4 and 6. "Log GDP per capita" varies from about 5 to 12. So the GDP per person would vary in this dataset from $150 to $160k.

### As reusable solution
```{r eval=FALSE, echo=TRUE, message=FALSE, include=TRUE}
####################################################################################
# Required libraries
library(tidyverse)
library(readxl)


####################################################################################
# Load data
load_data <- function(data_source){
  read_xls(paste(getwd(),data_source,sep="/"))
}

#Call the function to load the data
load_data("./archetypes/happiness-report-2020.xls")
####################################################################################

####################################################################################
# Find dimensions
f_dimensions <- function(df_dimensions) {
  dim(df_dimensions)
}

# Call the function with your values to the parameters
f_dimensions(df)
####################################################################################

####################################################################################
# Find structure: column name, column type and first rows
f_structure <- function(df_structure) {
  #glimpse(df_structure)
  str(df_structure)
}

# Call the function with your values to the parameters
f_structure(df)
####################################################################################

####################################################################################
# Count missing values 
f_missing_values <- function(df_missing_values) {
   purrr::map_df(df_missing_values, ~ sum(is.na(.))) %>%
   gather('Column name', 'Count of missing values')
}

# Call the function with your values to the parameters
f_missing_values(df)
####################################################################################

####################################################################################
# Display distinct values of a column
f_distinct_values <- function(df_distinct_values,...) {
 distinct(df_distinct_values,...) %>% arrange(...)
}

# Call the function with your values to the parameters
f_distinct_values(df,`Country name`)
####################################################################################

#########################################################################################
# Display frequency of the values of a column
f_frequency <- function(df_frequency,column) {

  df_tmp = table(column)
  as.data.frame(df_tmp) %>% 
   rename(Frequency_column=column ,Freq_absolute=Freq)  %>%
   mutate(Freq_relative=paste0(round(100*Freq_absolute/sum(Freq_absolute),digits=2),"%"))

}

# Call the function with your values to the parameters
f_frequency (df,df$Year)
#########################################################################################

#########################################################################################
# Display histograms of numerical variable
f_histogram <- function(df_histogram,column_1,column_2) {

  column_name1=deparse(substitute(column_1))
  column_name2=deparse(substitute(column_2))    
  
  df_long <- df_histogram %>%
  pivot_longer(
    column_name1:column_name2,
    names_to = "measure",
    values_to = "value"
  )

  ggplot(df_long, aes(x=value)) +
  geom_histogram(fill = "#79B8E5") +
  facet_wrap(~ measure, scales="free")+
  theme(panel.grid = element_blank(), 
        strip.background = element_blank(),
        panel.background = element_blank()
  ) 

  
}

# Call the function with your values to the parameters
f_histogram (df,`Life Ladder`,`Most people can be trusted, WVS round 2010-2014`)
#########################################################################################
```


### References
#### The citations and data sources used for this case

#### This case is based on a dataset that comes as an appendix of the following report <a href="https://worldhappiness.report/ed/2019/" target="_blank" rel="noopener noreferrer">7th World Happiness Report</a>. We will use this dataset in various patterns. (as a teaser, we will use this data to produce the graph in this article: <a href="https://www.economist.com/graphic-detail/2019/03/21/economic-growth-does-not-guarantee-rising-happiness" target="_blank" rel="noopener noreferrer">The Economist - Happiness and growth</a>). 

```{r generateBibliography, echo=FALSE, message=FALSE, warning=FALSE}

cleanbib()
options("citation_format" = "pandoc")
read.bibtex(file = "./citations/world-happiness-report.bib")

```

```{r, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE, class.source='fold-hide'}

# eval = FALSE as default; run manually as chunk

# ENTER METADATA
# Use space to separate keywords or "-" for phrases
methods <- "profile dimension distinct-values frenquency-values missing-values structure" # mostly used in wranglers and analytics
keywords <- 'happiness growth economics'
commands <- 'str dim distinct map_df mutate'
sources <- 'The-Economist'

# CREATE METADATA
source("../../../z-scripts/create_metadata.R", local = knitr::knit_global())

# RUN PRODUCTION OUTPUTS
source("../../../z-scripts/create_production_output.R", local = knitr::knit_global())


```


```{js, message=FALSE, warning=FALSE, echo=FALSE}

// Must be included to position footer
$(function() {
  $('.main-container').after($('.footer'));
})

```


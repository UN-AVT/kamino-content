---
pagetitle: "European energy"
output:
  html_document:
    theme: lumen
    css: "../../../z-assemblers/assets/styles/content.css"
    df_print: paged
    mathjax: NULL
    code_folding: show
    include:
      in_header: ["../../../z-assemblers/fragments/google-analytics.html", "../../../z-assemblers/fragments/header.html"]
      after_body: "../../../z-assemblers/fragments/footer.html"
    self_contained: false
    lib_dir: "vendor"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=FALSE)
options(scipen = 999) ## To disable scientific notation

# Clear environment and memory
rm(list = ls(all.names = TRUE)) # will clear all objects including hidden objects.
gc() #free up memory and report the memory usage.

# Load needed libraries
library(tidyverse)
library(ggiraph)

```

<div class="activity">
CHARTS
</div>

# Sources of energy production in Europe
## Mekko shifted

```{r, out.width = "60%", fig.align = 'center', fig.cap="Photo by Nikhita S on Unsplash"}

masthead <- "assets/curioso-photography-unsplash.jpg"
knitr::include_graphics(masthead, dpi=72)

```

> We are coming to a point of no return...\
--- Ant√≥nio Guterres on the climate crises \

***

### Load data


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-hide'}

# Create dataset
df = read_csv("archetypes/energy.csv")
df

```

### Data wrangling

Steps:  
* replace cell "890k" with "0.89" in "out of school" column and convert column to numeric  
* drop unnecessary columns  
* calculate total students by region, for the world, and calculate percentages  
* create a "diplay region" to help with labels on plot  


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-hide'}

df_final <- df %>%
  mutate(
    type = fct_other(
      type,
      keep = c("Nuclear", "Conventional thermal"),
      other_level="Renewable"
    ),
    type = fct_relevel(type, "Renewable", "Nuclear", "Conventional thermal")
  ) %>%
  select(country, country_name, type, value=`2018`) %>%
  group_by(country, country_name, type) %>%
  summarize(value = sum(value)) %>%
  ungroup() 
  
df_final

```

```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-hide'}

df_country_sort <- df_final %>%
  mutate(type = fct_other(type,
                          keep = c("Conventional thermal"),
                          other_level="non_co2_pollutant")) %>%
  group_by(country, type) %>%
  summarise(upper_value = sum(value)) %>%
  ungroup() %>%
  group_by(country) %>%
  mutate(total = sum(upper_value)) %>%
  ungroup() %>%
  filter(!type == "Conventional thermal") %>%
  mutate(percent_clean = 100 * upper_value / total) %>%
  arrange(desc(percent_clean)) %>%
  select(country, percent_clean)
  
df_country_sort
  
```

```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-hide'}

df_country_production <- df_final %>%
  group_by(country) %>%
  summarise(prod_by_country = sum(value)) %>%
  ungroup() %>%
  group_by() %>%
  mutate(prod_europe = sum(prod_by_country)) %>%
  ungroup() %>%
  group_by(country) %>%
  summarize(percent_production = 100 * prod_by_country / prod_europe) %>%
  ungroup() %>%
  arrange(desc(percent_production))

df_country_production

```

```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-hide'}
df_production_by_type <- df_final %>%
  pivot_wider(names_from = type, values_from = value)

df_production_by_type
```
```{r}
df_join <- inner_join(df_production_by_type, df_country_production) %>%
  inner_join(df_country_sort) %>%
  arrange(desc(percent_clean)) %>%
  mutate(xmax=cumsum(percent_production),
         xmin=xmax-percent_production) %>%
  mutate(total_country_energy = Renewable + Nuclear + `Conventional thermal`,
         percent_renewable = 100 * Renewable / total_country_energy,
         percent_nuclear = 100 * Nuclear / total_country_energy,
         percent_thermal = 100 * `Conventional thermal` / total_country_energy)

df_join

```


### Final plot

```{r, echo=TRUE, fig.width=12, fig.height=10, out.width = "95%", class.source = 'fold-hide'}

fill_colors <- c("Renewable" = "#ECC04F", 
                 "Nuclear" = "#F8EE5D", 
                 "Conventional thermal" = "#D2D2D2")

v1 <- ggplot(df_join) +
  geom_rect(aes(ymin = 0, ymax = percent_nuclear, xmin = xmin, xmax = xmax,
                fill = "Nuclear"),
            color = "#F6EC3A")+
  geom_rect(aes(ymin=percent_nuclear, ymax=percent_nuclear + percent_renewable,
                xmin = xmin, xmax = xmax,
                fill = "Renewable"),
            color = "#EABB26") +
  geom_rect(aes(ymin = 0, ymax = -percent_thermal,
                xmin = xmin, xmax = xmax,
                fill = "Conventional thermal"),
            color = "#C4C4C4") +
    scale_fill_manual(values = fill_colors) +
  geom_text(aes(x = (xmin+xmax)/2,
                y = percent_nuclear + percent_renewable,
                label = country),
            vjust = "bottom") +
  geom_segment(aes(x=-10, xend=110, y=100, yend=100), colour = "#D2D2D2") +
  geom_segment(aes(x=-10, xend=110, y=75, yend=75), colour = "#D2D2D2") +
  geom_segment(aes(x=-10, xend=110, y=50, yend=50), colour = "#D2D2D2") +
  geom_segment(aes(x=-10, xend=110, y=25, yend=25), colour = "#D2D2D2") +
  geom_segment(aes(x=-10, xend=110, y=0, yend=0), colour = "#D2D2D2") +
  geom_segment(aes(x=-10, xend=110, y=-25, yend=-25), colour = "#D2D2D2") +
  geom_segment(aes(x=-10, xend=110, y=-50, yend=-50), colour = "#D2D2D2") +
  geom_segment(aes(x=-10, xend=110, y=-75, yend=-75), colour = "#D2D2D2") +
  geom_segment(aes(x=-10, xend=110, y=-100, yend=-100), colour = "#D2D2D2") +
    theme_bw() +
    theme(panel.border = element_blank()) +
    theme(plot.background = element_blank()) +
    theme(panel.background = element_blank()) +
    theme(panel.grid.major.x = element_blank()) +
    theme(panel.grid.minor.x = element_blank()) +
    theme(panel.grid.major.y = element_blank()) +
    theme(panel.grid.minor.y = element_blank()) +
    theme(legend.title = element_blank()) +
    theme(axis.title.x = element_blank()) +
    theme(axis.title.y = element_blank()) +
    theme(axis.text.x = element_blank()) +
    theme(axis.text.y = element_blank()) +
    theme(axis.ticks.x = element_blank()) +
    theme(axis.ticks.y = element_blank()) +
    theme(legend.position = "top") +
  labs(title = "How European countries generated electricity in 2018") +
  annotate("text", x = -4, y = 0, label = "0%", hjust = 0) +
  annotate("text", x = -4, y = -25, label = "25%", hjust = 0) +
  annotate("text", x = -4, y = -50, label = "50%", hjust = 0) +
  annotate("text", x = -4, y = -75, label = "75%", hjust = 0) +
  annotate("text", x = -4, y = -100, label = "100% conventional thermal energy", hjust = 0)+
  annotate("text", x = 106, y = 0, label = "0%", hjust = 1)+
  annotate("text", x = 106, y = 25, label = "25%", hjust = 1)+
  annotate("text", x = 106, y = 50, label = "50%", hjust = 1)+
  annotate("text", x = 106, y = 75, label = "75%", hjust = 1)+
  annotate("text", x = 106, y = 100, label = "clean energy 100%", hjust = 1)+
  annotate("text", x = 10, y = 120, 
           label="Norway had an electricity production\nalmost entirely made up of renewable\nenergy (97%). It is the second largest\nproducer of this type of energy in Europe", 
           hjust = 0)+
  annotate("text", x = 60, y = 75, 
           label="Germany is the larger energy producer in\nEurope and also produce the most renewable\nand conventional thermal energy (representing\n31% and 56% of production, respectively).", 
           hjust = 0)+
  annotate("text", x = 15, y = -50, 
           label="France is the second larger energy producer\nin Europe but by far the largest nuclear energy\nprovider representing 71% of its production.).", 
           hjust = 0)+
  annotate("text", x = 70, y = -80, 
           label="Most of Poland's energy production is\nfrom conventional thermal energy (90%).", 
           hjust = 0)

girafe(ggobj = v1, width_svg = 13, height_svg = 9,
       options = list(opts_sizing(rescale = TRUE, width = 1.0)))


```

### References
#### The citations and data sources used for this case

* Narrative and data sources: Tidy Tuesday, [GO](https://github.com/rfordatascience/tidytuesday){target="_blank"}

```{r, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE, class.source='fold-hide'}

# eval = FALSE as default; run manually as chunk
# PUSH TO PRODUCTION
source("../../../z-scripts/create_production_output.R", local = knitr::knit_global())

```


```{js, message=FALSE, warning=FALSE, echo=FALSE}

// Must be included to position footer
$(function() {
  $('.main-container').after($('.footer'));
})

```

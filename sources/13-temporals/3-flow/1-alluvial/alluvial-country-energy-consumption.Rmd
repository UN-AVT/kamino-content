---
pagetitle: "Kamino"
output: 
  html_document:
    theme: lumen
    css: ["../../../z-assemblers/kamino.css", "../../../z-assemblers/temporals.css"]
    df_print: paged
    mathjax: NULL
    code_folding: show
    include:
      in_header: "../../../z-assemblers/header.html"
      after_body: "../../../z-assemblers/footer.html"
    #self_contained: false
    #lib_dir: libs
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo = FALSE)
options(scipen=999)  # turn-off scientific notation like 1e+48

library(reshape2)
library(tidyverse)
library(stringr)
library(ggplot2)
library(ggalluvial)
library(gridExtra)
library(ggthemes)

library(htmltools) # needed to include html snippets
library(knitcitations)
library(bibtex)

```

<div class="activity">
TEMPORALS
</div>

# Alluvial Plot
## Energy Consumption by Country & Fuel Type

<p>Alluvial diagrams are a type of <strong>flow diagram</strong> originally developed to represent changes in network structure over time. In allusion to both their visual appearance and their emphasis on flow, alluvial diagrams are named after alluvial fans that are naturally formed by the soil deposited from streaming water.</p>

<a href="https://github.com/owid/energy-data">Data Source: Our World in Data</a>

```{r, echo=FALSE}

df = read.csv("../archetypes/owid-energy-data-long.csv", header = TRUE, stringsAsFactors = FALSE)  # read text file 

# Filter for the fields used in each view
consumption_types <- c("biofuel_consumption", 
                  "coal_consumption", 
                  "oil_consumption", 
                  "gas_consumption", 
                  "hydro_consumption", 
                  "solar_consumption", 
                  "wind_consumption", 
                  "nuclear_consumption")

df <- df %>% filter(variable %in% consumption_types)

# Limit to decade intervals
years <- c(1970, 1980, 1990, 2000, 2010, 2019)
df <- df %>% filter(year %in% years)

# The specific country to generate the view
df_country <- df %>% filter(country == "Switzerland")

df_country

# Color palette for each energy type
energy_pal <- c("biofuel_consumption" = "#72A06A", 
                "coal_consumption" = "#36454f", 
                "oil_consumption" = "#373A36", 
                "gas_consumption" = "#7b9095", 
                "hydro_consumption" = "#386890", 
                "solar_consumption" = "#FDB813", 
                "wind_consumption" = "#7da7ca", 
                "nuclear_consumption" = "#FF7A00")

# Standard theme options to use for each view
theme_opts <- theme(
  legend.position = "bottom",
  legend.title = element_blank(),
  # axis.text = element_blank(),
  # axis.line = element_blank(),
  # axis.ticks = element_blank(),
  # axis.title = element_blank(),
  # panel.grid = element_blank(),
  # panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background=element_rect(fill="white", colour="white"),
  panel.border = element_blank(),
  plot.background = element_blank()
)

```

# Section
## Subsection

```{r, echo=FALSE, fig.width=11, fig.height=6}

# View using alluvium geom
v1 <- ggplot(data = df_country, aes(x = year, y = value, alluvium = variable)) +
  geom_alluvium(aes(fill = variable), size=1.5, colour = "#ffffff", alpha = 1.0, decreasing = FALSE) +
  # for set years
  scale_x_continuous(breaks = years) +
  # for aesthetics to show top-down
  scale_y_reverse() +
  # use the palette defined above
  scale_fill_manual(values = energy_pal) +
  # in case any marks fall outside panel
  coord_cartesian(clip = "off") +
  # a simple theme to modify
  theme_minimal() +
  # rotate years
  theme(axis.text.x = element_text(angle = -90, hjust = 1, vjust = 0.5)) +
  # use configured theme options
  theme_opts +
  labs(
    x="",
    y="",
    title="Country Energy Consumption by Fuel Type",
    subtitle="Switzerland"
  )

v1

```

# Section
## Subsection

```{r, echo=FALSE, fig.width=11, fig.height=7.5}

v2 <- ggplot(data = df_country, aes(x = year, y = value, alluvium = variable)) +
  geom_flow(aes(fill = variable, size = value), colour = "#ffffff", alpha = 1.0, decreasing = FALSE) +
  # for set years
  scale_x_continuous(breaks = years) +
  # for aesthetics to show top-down
  scale_y_reverse() +
  # use the palette defined above
  scale_fill_manual(values = energy_pal) +
  # scale line size so smallest values still show
  scale_size_continuous(range = c(0.75,2), breaks = c(0.75,2), guide = FALSE) +
  # in case any marks fall outside panel
  coord_cartesian(clip = "off") +
  # a simple theme to modify
  theme_minimal() +
  # rotate years
  theme(axis.text.x = element_text(angle = -90, hjust = 1, vjust = 0.5)) +
  # use configured theme options
  theme_opts +
  labs(
    x="",
    y="",
    title="Country Energy Consumption by Fuel Type",
    subtitle="Switzerland"
  )

v2

```

# Section
## Subsection

```{r, echo=FALSE}

# Save plot to svg file
# ggsave(filename = "alluvial-country-energy-consumption-switzerland-v1.svg", plot = v1, width=12, height=6)
# ggsave(filename = "alluvial-country-energy-consumption-switzerland-v2.svg", plot = v2, width=12, height=6)

```


# Exercises and practice
## Knime and R practice solutions



# References
## The citations and data sources used for this case

Source: <a href="https://www.economist.com/graphic-detail/2019/08/23/which-countries-dominate-the-worlds-dinner-tables"> Which countries dominate the worldâ€™s dinner tables?</a>

```{r generateBibliography, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}

# cleanbib()
# read.bibtex(file = "./citations.bib")

```


```{r, message=FALSE, warning=FALSE, echo=FALSE}

# echo=FALSE will exclude block from code folding
# Example for including external html content when needed
htmltools::includeHTML("mark-complete-button.html")

```



```{r, child='mark-complete-click.Rmd'}

# JS event handler for button click

```



```{js, message=FALSE, warning=FALSE, echo=FALSE}

// Must be included to position footer
$(function() {
  $('.main-container').after($('.footer'));
})

```



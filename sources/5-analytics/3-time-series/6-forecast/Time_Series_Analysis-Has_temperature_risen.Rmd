---
pagetitle: "Kamino"
output:
  bookdown::gitbook: default
documentclass: book
date: "`r Sys.Date()`"
---

```{r include=FALSE}
library(forecast)
library(tidyverse)
require(scales)
library(zoo)
library(naniar)
library(gridExtra)
library(ggiraph)
```


ANALYTICS


# Time series Analysis

## Tools to analyse time series.

> Winter Is Coming...\
--- motto of House Stark\

# Has temperature really risen in the past 100 years?

In this report, we put Time Series analysis into practice. We choose a simple measure, the __monthly average__ temperature (In fahrenheit) measured in Central Park, New York.


## Loading data

We will be using the average monthly temperature measured in New York Central Park since 1895
https://www.ncdc.noaa.gov/cag/city/time-series/USW00094728

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Load data
#setwd("C:/RProjects/Kamino_R")
# Central_Park_Temperature = read.csv("archetypes/USW00094728-tavg-all-8-1895-2020.csv", header=TRUE, stringsAsFactors=FALSE, skip = 4)

Central_Park_Temperature = read_csv("archetypes/USW00094728-tavg-all-8-1895-2020.csv", skip = 4)
Central_Park_Temperature



```

## Data wrangling

```{r echo=TRUE, message=FALSE, warning=FALSE}
Central_Park_Temperature <- Central_Park_Temperature %>% 
  mutate(Date = as.Date(paste0(substr(Date, 1,4),"-",substr(Date,5,7),"-01")))

Central_Park_Temperature

```

## Visualizing time series

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}
# libraries: requires gglot2 and scales
# Notice one record that registers at Value = -99. This indicates a missing element for that specific date
# the next effort will handle this problem

# theme parameters
theme_opts <- theme(
  legend.position = "none",
  legend.title = element_blank(),
  #axis.text = element_blank(),
  axis.line = element_blank(),
  #axis.ticks = element_blank(),
  #axis.title = element_blank(),
  panel.grid = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # panel.background = element_blank(),
  panel.background = element_rect(fill = "#ffffff"),
  panel.border = element_blank(),
  # plot.background = element_blank(),
  plot.background = element_rect(fill = "#ffffff")
)

v1<-ggplot(data=Central_Park_Temperature, aes(x=Date, y=Value, group=1)) +
  geom_line(color="grey") +
  geom_point(color="grey") + 
  scale_y_continuous(labels = comma) +
  theme_opts + 
  theme(plot.title = element_text(size=25)) + 
  theme(text = element_text(size = 20))
girafe(ggobj = v1, width_svg = 13, height_svg = 7,
       options = list(opts_sizing(rescale = TRUE, width = 1.0)))
```

We notice one odd measure (temperature of -99, which indicate absence of data). The following code replaces this data point with the value that came just before it.

Let's fix this.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Needs libraries naniar and dplyr
# replaces "-99" record with NA
CP_Temp <- Central_Park_Temperature %>% 
  replace_with_na_all(condition = ~.x == -99)

# Needs library zoo
# Replaces NA records by the Value of the record that comes just before it
CP_Temp <- na.locf(CP_Temp)

```

```{r echo=TRUE, message=FALSE, warning=FALSE}
before <- Central_Park_Temperature %>%
  filter(Date > "1970-01-01", Date < "1970-05-01") %>%
  select(Date, Value)

print("before")
before

after <- CP_Temp %>%
  filter(Date > "1970-01-01", Date < "1970-05-01") %>%
  select(Date, Value)
print("after")
after
```


```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}

# theme parameters
theme_opts <- theme(
  legend.position = "none",
  legend.title = element_blank(),
  #axis.text = element_blank(),
  axis.line = element_blank(),
  #axis.ticks = element_blank(),
  #axis.title = element_blank(),
  panel.grid = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # panel.background = element_blank(),
  panel.background = element_rect(fill = "#ffffff"),
  panel.border = element_blank(),
  # plot.background = element_blank(),
  plot.background = element_rect(fill = "#ffffff")
)

# Redrawind the plot, all records are now within the expected band
v2<-ggplot(data=CP_Temp, aes(x=Date, y=Value, group=1)) +
  geom_line(color="grey") +
  geom_point(color="grey") + 
  scale_y_continuous(labels = comma) +
  theme_opts + 
  theme(plot.title = element_text(size=25)) + 
  theme(text = element_text(size = 20))
girafe(ggobj = v2, width_svg = 13, height_svg = 7,
       options = list(opts_sizing(rescale = TRUE, width = 1.0)))
```

## Can we answer the question already using a simple regression line?

We can already notice the trend upwards.

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}

# theme parameters
theme_opts <- theme(
  legend.position = "none",
  legend.title = element_blank(),
  #axis.text = element_blank(),
  axis.line = element_blank(),
  #axis.ticks = element_blank(),
  #axis.title = element_blank(),
  panel.grid = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # panel.background = element_blank(),
  panel.background = element_rect(fill = "#ffffff"),
  panel.border = element_blank(),
  # plot.background = element_blank(),
  plot.background = element_rect(fill = "#ffffff")
)

# Adding a linear regression line, we already see the trend upwards. 
v3<-ggplot(data=CP_Temp, aes(x=Date, y=Value, group=1)) +
  geom_line(color="grey") +
  geom_point(color="grey") + 
  scale_y_continuous(labels = comma) + 
  #theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  #geom_smooth(method="lm", se=FALSE) +
  geom_smooth(method="lm") +
  theme_opts + 
  theme(plot.title = element_text(size=25)) + 
  theme(text = element_text(size = 20))
girafe(ggobj = v3, width_svg = 13, height_svg = 7,
       options = list(opts_sizing(rescale = TRUE, width = 1.0)))
```

## Creating time series

When working with time series, r uses a convenient special object called "ts".  
Important parameters:  

* Frequency: The “frequency” is the "number of observations before the seasonal pattern repeats", or also described as the "number of observations per unit of time". 
  * Annual: Frequency = 1
  * Quartely: Frequency = 4
  * Monthly: Frequency = 12
  * Weekly: Frequency = 52


* Start, End: the time of the first and last observations
  * Date format depends on Frequency: c(1895,01) means for example January 1895.

Here, we choose Frequency = 12 since we deal with monthly time series.


```{r}
# Time to create a univariate time-series
univar <- data.frame(CP_Temp$Value)

# Creating a time series
TimeSer <- ts(univar, start=c(1895,1), end=c(2020,8), frequency=12)
TimeSer

```


## Analysing seasonality

### Seasonal plot

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}
# Library: requires forecast

# Data exploration using graphs
v4<-ggseasonplot(TimeSer, year.labels = TRUE) +
  ylab("Temperature (F)") +
  ggtitle("Seasonal plot: Temperature per month") +
  theme_opts + 
  theme(plot.title = element_text(size=25)) + 
  theme(text = element_text(size = 20))
girafe(ggobj = v4, width_svg = 13, height_svg = 7,
       options = list(opts_sizing(rescale = TRUE, width = 1.0)))
```

### polar seasonal plot

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}
# Library: requires forecast

v5<-ggseasonplot(TimeSer, year.labels = TRUE, polar=TRUE)+
  ylab("Temperature (F)") +
  ggtitle("Polar seasonal plot: Temperature per month") +
  #=theme_opts + 
  theme(plot.title = element_text(size=25)) + 
  theme(text = element_text(size = 20))
girafe(ggobj = v5, width_svg = 13, height_svg = 7,
       options = list(opts_sizing(rescale = TRUE, width = 1.0)))
```

### Seasonal subseries

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}
# Library: requires forecast

# The horizontal lines indicate the means for each month
v6<-ggsubseriesplot(TimeSer)+
  ylab("Temperature (F)") +
  ggtitle("Seasonal subseries plot: Temperature per month") +
  theme_opts + 
  theme(plot.title = element_text(size=25)) + 
  theme(text = element_text(size = 20))
girafe(ggobj = v6, width_svg = 13, height_svg = 7,
       options = list(opts_sizing(rescale = TRUE, width = 1.0)))
```

## Autocorrelation

Similar to correlation between two two variables, autocorrelation measures the relationship between lagged values of a time series.

### ACF

The dashed blue lines indicate whether the correlations are significantly different from zero. 

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}

v7<-ggAcf(TimeSer) +
  theme_opts + 
  theme(plot.title = element_text(size=25)) + 
  theme(text = element_text(size = 20))
girafe(ggobj = v7, width_svg = 13, height_svg = 7,
       options = list(opts_sizing(rescale = TRUE, width = 1.0)))
```

Time series that show no autocorrelation are called __white noise__. See example below

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}
set.seed(30)
whitenoise <- ts(rnorm(50))
v8<-autoplot(whitenoise) + ggtitle("White noise") +
  theme_opts + 
  theme(plot.title = element_text(size=25)) + 
  theme(text = element_text(size = 20))

girafe(ggobj = v8, width_svg = 13, height_svg = 7,
       options = list(opts_sizing(rescale = TRUE, width = 1.0)))
```

As expected, there is no obvious correlation

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}

v9<-ggAcf(whitenoise) +
  theme_opts + 
  theme(plot.title = element_text(size=25)) + 
  theme(text = element_text(size = 20))
girafe(ggobj = v9, width_svg = 13, height_svg = 7,
       options = list(opts_sizing(rescale = TRUE, width = 1.0)))
```

### Decomposition

```{r, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}

v10<-TimeSer %>% decompose(type="multiplicative") %>%
  autoplot() + xlab("Year") +
  ggtitle("decomposition") +
  theme_opts + 
  theme(plot.title = element_text(size=25)) + 
  theme(text = element_text(size = 20))
girafe(ggobj = v10, width_svg = 13, height_svg = 7,
       options = list(opts_sizing(rescale = TRUE, width = 1.0)))
```

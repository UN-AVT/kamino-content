---
pagetitle: "Beer production"
output: 
  html_document:
    theme: lumen
    css: "../../../z-assemblers/assets/styles/content.css"
    df_print: paged
    mathjax: NULL
    code_folding: show
    include:
      in_header: ["../../../z-assemblers/fragments/google-analytics.html", "../../../z-assemblers/fragments/header.html"]
      after_body: "../../../z-assemblers/fragments/footer.html"
    self_contained: false
    lib_dir: "vendor"
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo = FALSE)
options(scipen = 999) ## To disable scientific notation

# Clear environment and memory
rm(list = ls(all.names = TRUE)) #will clear all objects includes hidden objects.
gc() #free up memrory and report the memory usage.

library(tidyverse)
library(ggiraph)

library(showtext)
## Loading Google fonts (https://fonts.google.com/)
font_add_google("Inconsolata", "inconsolata")
# turn on showtext
showtext_auto()

```

<div class="activity">
SEMIOGRAPHIC  
</div>

# Beer production
# imitation

```{r, out.width="60%", fig.align="center", fig.cap="Photo by Engin Akyurt on Unsplash"}

masthead <- "assets/engin-akyurt-unsplash.jpg"
knitr::include_graphics(masthead, dpi=72)

```


> On victory, you deserve beer, in defeat, you need it...\
--- Napoleon\

***


### Ingest
#### brewers and barrels by year


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-hide'}

df_ingest <- read.csv("archetypes/beer-production/beer-production.csv", header = TRUE)
df_ingest

```


### Wrangle
#### brewers and barrels by year


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-hide'}



```




```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-hide'}

df_wrangle <- 
  df_ingest %>% 
  filter(
    brewer_size %in% c("Under 1 Barrel", "1 to 1,000 Barrels")
  ) %>% 
  mutate(year_mod = year + (year %% min(year, na.rm = T) + 1)) %>% 
  group_by(year, year_mod) %>% 
  summarize(
    n_of_brewers = sum(n_of_brewers, na.rm = T),
    total = sum(total_barrels, na.rm = T)
  ) %>% 
  mutate(label = glue::glue("{format(round(total / 10^6, 2), nsmall = 2)}M"))

df_wrangle

df_ticks <-
  df_wrangle %>% 
  slice(rep(1, each = 5)) %>% 
  mutate(
    tick = seq(0.25*10^6, 1.25*10^6, by = 2.5*10^5),
    label = c("0.25", "0.50", "0.75", "1.00", "1.25")
  ) %>% 
  filter(tick < total - 50000)
  
set.seed(2)

df_bubbles <-
  df_wrangle %>% 
  slice(rep(1, each = floor(n_of_brewers / 100))) %>% 
  mutate(
    dots_brewer = runif(n_of_brewers, 20000, total - 20000),
    dot_size = runif(n_of_brewers, 0, 1)
  )

df_bubbles

```


### Plot
#### beer and bubbles


```{r, message=FALSE, warning=FALSE, echo=TRUE, fig.width=13, fig.height=5, fig.align='center', out.width="100%"}

theme_opts <- theme(
    text = element_text(family = "inconsolata"), 
    plot.title = element_text(color = "black", size = 14, face = "bold"),
    plot.subtitle = element_text(color = "black", size = 12),
    plot.caption = element_text(color = "#555555", size = 8),
    plot.background = element_rect(fill = "#3c2554", color = "#3c2554"),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = 28, color = "#e0d796", margin = margin(t = 10)),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    plot.margin = margin(0, 30, 30, 30)
)

v1 <- ggplot(df_wrangle, aes(year_mod, total)) +
    geom_segment(data = df_wrangle %>% slice(1),
                 aes(x = year_mod - .6, 
                      xend = year_mod + .6,
                      yend = total),
                 color = "white",
                 size = 35) +
    geom_col(fill = "#f9e556", width = 1.2) +
    ## bubbles
    geom_jitter(data = df_bubbles,
                aes(year_mod, dots_brewer, size = dot_size, alpha = dot_size),
                position = position_jitter(width = .38, seed = 1),
                shape = 21,
                color = colorspace::lighten("#f9e556", .17),
                fill = "white",
                stroke = .5) +
    ## scale bar
    geom_segment(data = df_wrangle,
                 aes(x = year_mod + .676,
                     xend = year_mod + .676,
                     y = 0,
                     yend = total),
                 color = "white",
                 size = 1.5) +
    # total label
    geom_segment(data = df_wrangle,
                 aes(x = year_mod + .655,
                     xend = year_mod + .77,
                     y = total - 3500,
                     yend = total - 3500),
                 color = "white",
                 size = 1.5) +
    geom_text(aes(year_mod + .83, 
                  total - 3500,
                  label = label),
              family = "Roboto Mono",
              fontface = "bold",
              color = "white",
              size = 4,
              hjust = 0) +
    ## null label
    geom_segment(data = df_wrangle,
                 aes(x = year_mod + .655,
                     xend = year_mod + .77,
                     y = 3500,
                     yend = 3500),
                 color = "white",
                 size = 1.5) +
    geom_text(aes(year_mod + .83, 
                  3500,
                  label = "0.00"),
              family = "Roboto Mono",
              fontface = "bold",
              color = "white",
              size = 4,
              hjust = 0) +
    ## other ticks
    geom_segment(data = df_ticks,
                 aes(x = year_mod + .675,
                     xend = year_mod + .78,
                     y = tick,
                     yend = tick),
                 color = "white",
                 size = .8) +
    ## title
    annotate("text", x = 2017, y = 1.5*10^6, 
             label = "The Rise of Craft Beer !",
             family = "Bangers",
             color = "#f9e556",
             size = 40,
             hjust = .5) +
    ## subtitle
    annotate("text", x = 2017, y = 1.27*10^6, 
             label = "Beer production of small US breweries with brewer sizes below 1,000 barrels increased by 225%\nover the last ten years. In the same time also the number of brewers increased by around 290%.",
             family = "Open Sans",
             fontface = "bold",
             lineheight = .99,
             color = "#e0d796",
             size = 6,
             hjust = .5) +
    annotate("text", x = 2017, y = 1.18*10^6, 
             label = "The yellow bars show the number of total barrels of beer produced by year and each bubble represents 100 brewers.",
             family = "Open Sans",
             color = "#e0d796",
             size = 5,
             hjust = .5) +
    scale_x_continuous(expand = c(.005, .005),
                       limits = c(NA, max(df_wrangle$year_mod) + 1.2),
                       breaks = seq(min(df_wrangle$year_mod), max(df_wrangle$year_mod), by = 2),
                       labels = c(min(df_wrangle$year):max(df_wrangle$year))) +
    scale_y_continuous(expand = c(.005, .005),
                       limits = c(0, 1750000)) +
    scale_size(range = c(2, 5), guide = F) +
    scale_alpha_continuous(range = c(0.2, 0.6), guide = F) +
    labs(x = NULL, y = NULL) +
    theme_minimal() +
    theme_opts

 girafe(ggobj = v1, width_svg = 16, height_svg = 9,
        options = list(opts_sizing(rescale = TRUE, width = 1)))

```


### References
#### citations for narrative and data sources

* Narrative: 
* Data source: Beer Production by [TTB](https://www.ttb.gov/beer/statistics)


```{r, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE, class.source='fold-hide'}

# eval = FALSE as default; run manually as chunk
# PUSH TO PRODUCTION
source("../../../z-scripts/create_production_output.R", local = knitr::knit_global())

```


```{js, message=FALSE, warning=FALSE, echo=FALSE}

// Must be included to position footer
$(function() {
  $('.main-container').after($('.footer'));
})

```


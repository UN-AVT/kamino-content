---
pagetitle: "Reduced child deaths"
output:
  html_document:
    theme: lumen
    css: "../../../z-assemblers/assets/styles/content.css"
    df_print: paged
    mathjax: NULL
    code_folding: show
    include:
      in_header: ["../../../z-assemblers/fragments/google-analytics.html", "../../../z-assemblers/fragments/header.html"]
      after_body: "../../../z-assemblers/fragments/footer.html"
    self_contained: false
    lib_dir: "vendor"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=FALSE)
options(scipen=999)  # turn-off scientific notation like 1e+48

# Clear environment and memory
rm(list = ls(all.names = TRUE)) #will clear all objects includes hidden objects.
gc() #free up memrory and report the memory usage.

library(tidyverse)
library(countrycode)
library(ggplot2)
library(treemapify)
library(ggiraph)

library(kableExtra)
library(knitcitations)
library(bibtex)

library(showtext)
## Loading Google fonts (https://fonts.google.com/)
font_add_google("Inconsolata", "inconsolata")
# turn on showtext
showtext_auto()

```

<div class="activity">
TREES  
</div>

# Reduced child deaths
## The Treemap


```{r, out.width = "60%", fig.align = 'center', fig.cap="Photo by Avel Chuklanov on Unsplash"}

masthead <- "assets/avel-chuklanov-unsplash.jpg"
knitr::include_graphics(masthead, dpi=72)

```

> History will judge us by the difference we make in the everyday lives of children...\
--- Nelson Mandela\

Every single country has seen a reduction in child deaths (since 1950). Under five mortality rate (% of children that die before they are 5 years old)

***

### Ingest the data
#### occupations, industries, and number of people in the top 1 percent


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-hide'}

# Load data
df = read.csv("./archetypes/reduced-child-deaths/reduced-child-deaths.csv", header = TRUE, stringsAsFactors = FALSE)  # read text file 
df

```


### Wrangle the data
#### parse numbers and enrich with region


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-hide'}

df_wrangle <- df
df_wrangle$X..change.1950.2015 <- as.numeric(sub("%", "", df_wrangle$X..change.1950.2015))
df_wrangle$X..change.1950.2015 <- as.numeric(sub("-", "", df_wrangle$X..change.1950.2015))
df_wrangle$un_region <- countrycode(df_wrangle$under_five_mortality_rate, origin='country.name', destination='un.region.name')
colnames(df_wrangle) <- c("COUNTRY", "MEASURE", "REGION")

df_wrangle <- filter(df_wrangle, nchar(REGION) > 0)
df_wrangle

```



### Analyze the data
#### Create a quartile column to use for color mapping

The within function is used for calculating new columns. The quantile function calculates the quartiles where 0:4/4 evaluates to c(0, 0.25, 0.50, 0.75, 1). Finally the cut function splits the data into the calculated quartiles. Casting the result to integers returns groups labeled as 1,2,3,4. The column is converted to a factor for use with a discrete color scale.


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-hide'}

df_analysis <- within(df_wrangle, quartile <- factor(as.integer(cut(MEASURE, quantile(MEASURE, probs=0:4/4), include.lowest=TRUE))))
df_analysis

```


### The Layout
#### squarified with size and fill


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source ='fold-hide', fig.width=1920/72, fig.height=1080/72, out.width="100%"}

# Layouts
# squarified" (the default), "scol", "srow" or "fixed"
# Simple
v1 <- ggplot(df_analysis, aes(area = MEASURE, fill = quartile)) +
  geom_treemap(color = "#ffffff", layout = 'fixed') +
  scale_fill_brewer(palette = "PiYG") +
  theme_minimal() +
  theme(legend.position = "bottom")

girafe(ggobj = v1, width_svg = 1280/72, height_svg = 720/72,
       options = list(opts_sizing(rescale = TRUE, width = 1.0))
)

```


#### with labels


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source ='fold-hide', fig.width=1920/72, fig.height=1080/72, out.width="100%"}

# Labeled
v2 <- ggplot(df_analysis, aes(area = MEASURE, fill = quartile, label = COUNTRY)) +
  geom_treemap(color = "#ffffff", layout = 'fixed') +
  geom_treemap_text(fontface = "italic", colour = "white", place = "centre", grow = TRUE, layout = 'fixed') +
  scale_fill_brewer(palette = "PiYG") +
  theme_minimal() +
  theme(legend.position = "bottom")

girafe(ggobj = v2, width_svg = 1280/72, height_svg = 720/72,
       options = list(opts_sizing(rescale = TRUE, width = 1.0))
)

```


#### with labels and color palette


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source ='fold-hide', fig.width=1920/72, fig.height=1080/72, out.width="100%"}

# Sub-grouping
v3 <- ggplot(df_analysis, aes(area = MEASURE, fill = quartile, label = COUNTRY, subgroup = REGION)) +
  geom_treemap(color = "#ffffff", layout = 'fixed') +
  geom_treemap_subgroup_border(colour = "white", layout = 'fixed') +
  geom_treemap_subgroup_text(place = "centre", grow = T, alpha = 0.5, colour =
                               "black", fontface = "italic", min.size = 0, layout = 'fixed') +
  geom_treemap_text(colour = "white", place = "topleft", reflow = T, layout = 'fixed') +
  scale_fill_brewer(palette = "PiYG") +
  theme_minimal() +
  theme(legend.position = "bottom")

# v3

girafe(ggobj = v3, width_svg = 1280/72, height_svg = 720/72,
       options = list(opts_sizing(rescale = TRUE, width = 1.0))
)

```


#### as facets


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source ='fold-hide', fig.width=1920/72, fig.height=1080/72, out.width="100%"}

# Sub-grouping
v4 <- ggplot(df_analysis, 
             aes(area = MEASURE, fill = quartile, label = COUNTRY)) +
  geom_treemap(color = "#ffffff", layout = 'fixed') +
  facet_wrap( ~REGION) +
  scale_fill_brewer(palette = "PiYG") +
  geom_treemap_text(colour = "white", place = "topleft", reflow = T, layout = 'fixed') +
  theme_minimal()+
  theme(legend.position = "bottom")

girafe(ggobj = v4, width_svg = 1280/72, height_svg = 1280/72,
       options = list(opts_sizing(rescale = TRUE, width = 1.0))
)

```


### References
#### citations for narrative and data sources

* Narrative and Data Sources: Our World in Data, Child Mortality, https://ourworldindata.org/child-mortality  


```{r, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE, class.source='fold-hide'}

# eval = FALSE as default; run manually as chunk
# PUSH TO PRODUCTION
source("../../../z-scripts/create_production_output.R", local = knitr::knit_global())

```


```{js, message=FALSE, warning=FALSE, echo=FALSE}

// Must be included to position footer
$(function() {
  $('.main-container').after($('.footer'));
})

```

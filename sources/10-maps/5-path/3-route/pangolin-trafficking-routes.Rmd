---
pagetitle: "Pangolin Trafficking Routes"
output: 
  html_document:
    theme: lumen
    css: "../../../z-assemblers/assets/styles/content.css"
    df_print: paged
    mathjax: NULL
    code_folding: show
    include:
      in_header: ["../../../z-assemblers/fragments/google-analytics.html", "../../../z-assemblers/fragments/header.html"]
      after_body: "../../../z-assemblers/fragments/footer.html"
    self_contained: false
    lib_dir: "vendor"
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo = FALSE)
options(scipen = 999) ## To disable scientific notation

# Clear environment and memory
rm(list = ls(all.names = TRUE)) #will clear all objects includes hidden objects.
gc() #free up memory and report the memory usage.

library(tidyverse)
library(janitor)
library(countrycode)
library(geojsonio)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggrepel)
library(ggiraph)

library(showtext)
## Loading Google fonts (https://fonts.google.com/)
font_add_google("Inconsolata", "inconsolata")
# turn on showtext
showtext_auto()

```

<div class="activity">
MAPS
</div>

# Pangolin Trafficking Routes
## Route Map

```{r, out.width="60%", fig.align="center", fig.cap="Photo by Louis Mornaud on Unsplash"}

masthead <- "assets/louis-mornaud-unsplash.jpg"
knitr::include_graphics(masthead, dpi=72)

```

> Above all else, though, he prides himself on his skill at trapping pangolins,\
  one of the most elusive but lucrative creatures in the forest...\
--- Rachel Love Nuwer, Poached: Inside the Dark World of Wildlife Trafficking\

***


### Ingest
#### trafficking routes


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-hide'}

df <- read.csv("archetypes/pangolin-trafficking-routes/pangolin-trafficking-routes.csv", header = TRUE, fileEncoding = "utf-8")
head(df, n=10)

```


### Wrangle
#### clean


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-hide'}

df_wrangled <- df %>% janitor::clean_names() %>%
             mutate(date = as.POSIXlt(date), 
                    latitude = as.numeric(latitude), 
                    longitude = as.numeric(longitude),
                    scale = as.integer(scale),
                    carcass = as.integer(carcass),
                    live = as.integer(live))

head(df_wrangled, n=10)

```


### Wrangle
#### summarize


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-hide'}

df_total <- df_wrangled %>%
  rowwise() %>%
  mutate(total = sum(scale,carcass,live, na.rm = T))

df_total$route_id <- seq.int(nrow(df_total))

head(df_total, n=10)

```


### Wrangle
#### enrich with country codes


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-show'}

df_total$via_iso3c <- countrycode(df_total$via, origin = 'country.name', destination = 'iso3c')
df_total$outbound_iso3c <- countrycode(df_total$outbound, origin = 'country.name', destination = 'iso3c')

```


### Wrangle
#### create coordinates for path


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-hide'}

centroids <- read.csv("https://raw.githubusercontent.com/UN-AVT/kamino-source/main/sources/0-shared/lookups/country-centroids.csv", header = TRUE)
centroids <- centroids %>% select(iso3c, latitude, longitude)
head(centroids, n=10)

via_only <- filter(df_total, nchar(via) > 0 & nchar(outbound) == 0)
via_only <- merge(via_only, centroids, by.x = "via_iso3c", by.y = "iso3c")
via_only <- via_only %>% rename(from_latitude = latitude.x, from_longitude = longitude.x, via_latitude = latitude.y, via_longitude = longitude.y)
#via_only

via_to <- filter(df_total, nchar(via) > 0 & nchar(outbound) > 0)
via_to <- merge(via_to, centroids, by.x = "via_iso3c", by.y = "iso3c")
via_to <- merge(via_to, centroids, by.x = "outbound_iso3c", by.y = "iso3c")
via_to <- via_to %>% rename(from_latitude = latitude.x, from_longitude = longitude.x, via_latitude = latitude.y, via_longitude = longitude.y, to_latitude = latitude, to_longitude = longitude)
#via_to

to_only <- filter(df_total, nchar(via) == 0 & nchar(outbound) > 0)
to_only <- merge(to_only, centroids, by.x = "outbound_iso3c", by.y = "iso3c")
to_only <- to_only %>% rename(from_latitude = latitude.x, from_longitude = longitude.x, to_latitude = latitude.y, to_longitude = longitude.y)
#to_only

no_dest <- filter(df_total, nchar(via) == 0 & nchar(outbound) == 0)
#no_dest

```


### Wrangle
#### create points for hubs (origin, via, and destination)


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-hide'}

df_location_points <- df_total %>%
  select(location, latitude, longitude, total) %>%
  group_by(location, latitude, longitude) %>%
  mutate(total = sum(total, na.rm = T), type = "location")
  
df_via_points_a <- via_only %>%
  select(via, via_latitude, via_longitude, total) %>%
  group_by(via, via_latitude, via_longitude) %>%
  rename(location = via, latitude = via_latitude, longitude = via_longitude) %>%
  mutate(total = sum(total, na.rm = T), type = "via")

df_via_points_b <- via_to %>%
  select(via, via_latitude, via_longitude, total) %>%
  group_by(via, via_latitude, via_longitude) %>%
  rename(location = via, latitude = via_latitude, longitude = via_longitude) %>%
  mutate(total = sum(total, na.rm = T), type = "via")

df_via_points <- rbind(df_via_points_a, df_via_points_b)
  
df_outbound_points_a <- via_to %>%
  select(outbound, to_latitude, to_longitude, total) %>%
  group_by(outbound, to_latitude, to_longitude) %>%
  rename(location = outbound, latitude = to_latitude, longitude = to_longitude) %>%
  mutate(total = sum(total, na.rm = T), type = "outbound")

df_outbound_points_b <- to_only %>%
  select(outbound, to_latitude, to_longitude, total) %>%
  group_by(outbound, to_latitude, to_longitude) %>%
  rename(location = outbound, latitude = to_latitude, longitude = to_longitude) %>%
  mutate(total = sum(total, na.rm = T), type = "outbound")

df_outbound_points <- rbind(df_outbound_points_a, df_outbound_points_b)

df_all_points <- rbind(df_location_points, df_via_points, df_outbound_points)
# df_all_points

df_points <- df_all_points %>%
  group_by(location, latitude, longitude, type) %>%
  mutate(total = sum(total, na.rm = T))

df_points$point_id <- seq.int(nrow(df_points))

head(df_points, n=10)

```


### Wrangle
#### create paths

* origin -> via
* origin -> via -> destination
* origin -> destination

```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-hide'}

# via paths
df_from <- via_only %>% select(route_id, location, scale, carcass, live, total, from_latitude, from_longitude ) %>% rename(latitude = from_latitude, longitude = from_longitude) %>% mutate(path_index = 0)
df_to <- via_only %>% select(route_id, via, scale, carcass, live, total, via_latitude, via_longitude ) %>% rename(location = via, latitude = via_latitude, longitude = via_longitude) %>% mutate(path_index = 1)
df_via_paths <- rbind(df_from, df_to)
#df_via_paths

# via and to paths
df_from <- via_to %>% select(route_id, location, scale, carcass, live, total, from_latitude, from_longitude ) %>% rename(latitude = from_latitude, longitude = from_longitude) %>% mutate(path_index = 0)
df_via <- via_to %>% select(route_id, via, scale, carcass, live, total, via_latitude, via_longitude ) %>% rename(location = via, latitude = via_latitude, longitude = via_longitude) %>% mutate(path_index = 1)
df_to <- via_to %>% select(route_id, outbound, scale, carcass, live, total, to_latitude, to_longitude ) %>% rename(location = outbound, latitude = to_latitude, longitude = to_longitude) %>% mutate(path_index = 2)
df_via_to_paths <- rbind(df_from, df_via, df_to)
#df_via_to_paths

# to paths
df_from <- to_only %>% select(route_id, location, scale, carcass, live, total, from_latitude, from_longitude ) %>% rename(latitude = from_latitude, longitude = from_longitude) %>% mutate(path_index = 0)
df_to <- to_only %>% select(route_id, outbound, scale, carcass, live, total, to_latitude, to_longitude ) %>% rename(location = outbound, latitude = to_latitude, longitude = to_longitude) %>% mutate(path_index = 2)
df_to_paths <- rbind(df_from, df_to)
#df_to_paths

df_all_paths <- rbind(df_via_paths, df_via_to_paths, df_via_to_paths)
df_all_paths <- df_all_paths %>% arrange(route_id, path_index) %>% distinct()
head(df_all_paths, n=10)

```


### Base map, natural earth, option 2
#### world


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-show'}

# natural earth base map
ne_world <- ne_countries(scale = "small", returnclass = "sf")
# removes Antarctica
ne_world <- filter(ne_world, iso_a3 != "ATA") 

```


### Route map
#### paths and points


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source ='fold-hide', out.width="100%"}

theme_opts <- theme(
  text = element_text(family = "inconsolata"), 
  plot.title = element_text(color = "black", size = 16, face = "bold", family = "inconsolata"),
  plot.subtitle = element_text(color = "black", size = 14, family = "inconsolata"),
  plot.caption = element_text(color = "#555555", size = 8, family = "inconsolata"),    
  plot.background = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background=element_rect(fill="#B0BEC5", colour="#B0BEC5"),
  panel.border = element_blank(),
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  axis.title = element_blank(),
  legend.title = element_blank(),
  legend.position = "bottom"
)

point_shapes <- c(
  "location" = 24,
  "via" = 21,
  "outbound" = 25
)

v1 <- ggplot(data = ne_world) +
  geom_sf(fill="#ECEFF1", color="#90A4AE", stroke=0.5) +
  geom_path( data = df_all_paths, aes(x=longitude, y=latitude, group=factor(route_id)), color = "transparent", fill = 'white', size=3, alpha = 0.6) +
  geom_path( data = df_all_paths, aes(x=longitude, y=latitude, group=factor(route_id), alpha = total), color = "#F06292", size=0.75) +
  geom_point_interactive(data = df_points, aes(x=longitude, y=latitude, size = total, shape = type, tooltip = paste0("location: ", location, "\nType: ", type, "\nTotal: ", total), data_id = point_id), fill = "#F06292", color = "black") +
  scale_shape_manual(values = point_shapes) +
  scale_alpha_continuous(range = c(0.25, 1), guide = FALSE) +
  scale_size_continuous(range = c(1, 5), guide = FALSE) +
  xlim(-20, 150) +
  ylim(-30, 60) +
  theme_bw() +
  labs(x="",
       y="",
       title = "Pangolin Trafficking Routes", 
       subtitle="2000-2014") +
  theme_opts
  
girafe(ggobj = v1, width_svg = 13, height_svg = 7.5,
       options = list(opts_sizing(rescale = TRUE, width = 1.0))
)

```


### References
#### citations for narrative and data sources

* Data: Pangolin Project Data Catalog, [GO](https://roytangrb.github.io/pangolin/tHVzFgDQ18lvaol7/){target="_blank"}


```{r, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE, class.source='fold-hide'}

# eval = FALSE as default; run manually as chunk
# PUSH TO PRODUCTION
source("../../../z-scripts/create_production_output.R", local = knitr::knit_global())

```


```{js, message=FALSE, warning=FALSE, echo=FALSE}

// Must be included to position footer
$(function() {
  $('.main-container').after($('.footer'));
})

```

---
pagetitle: "Most Liveable Cities"
output:
  html_document:
    theme: lumen
    css: "../../../z-assemblers/assets/styles/content.css"
    df_print: paged
    mathjax: NULL
    code_folding: show
    include:
      in_header: ["../../../z-assemblers/fragments/google-analytics.html", "../../../z-assemblers/fragments/header.html"]
      after_body: "../../../z-assemblers/fragments/footer.html"
    self_contained: false
    lib_dir: "vendor"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo = FALSE)
options(scipen = 999) ## To disable scientific notation

# Clear environment and memory
rm(list = ls(all.names = TRUE)) #will clear all objects includes hidden objects.
gc() #free up memrory and report the memory usage.

library(tidyverse)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggrepel)
library(ggiraph)

library(showtext)
## Loading Google fonts (https://fonts.google.com/)
font_add_google("Inconsolata", "inconsolata")
# turn on showtext
showtext_auto()

```

<div class="activity">
MAPS  
</div>

# Most Liveable Cities
## Dot Map

```{r, out.width = "60%", fig.align = 'center', fig.cap="Photo by Alex Rainer on Unsplash"}

masthead <- "assets/alex_rainer-unsplash.jpg"
knitr::include_graphics(masthead, dpi=72)

```


> The streets of Vienna are paved with culture, the streets of other cities with asphalt...\
--- Karl Kraus\

***


### Ingest
#### city ranks


```{r, message=FALSE, warning=FALSE, echo=FALSE}

df <- read.csv("archetypes/most-liveable-cities/mercer-quality-of-living-city-ranking.csv", header = TRUE, stringsAsFactors = FALSE, fileEncoding = "utf-8")
head(df, n = 10)

```


### Wrangle
#### enrich with coordinates


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-hide'}

df <- df %>% select(Rank, City, Country)

all_cities <- read.csv("archetypes/most-liveable-cities/ne_10m_populated_places.csv", header = TRUE, stringsAsFactors = FALSE, encoding = "utf-8")
all_cities <- all_cities %>% select(NAME, NAMEASCII, ADM0NAME, LATITUDE, LONGITUDE)

df_coords <- merge(df, all_cities, by.x = c("City", "Country"), by.y = c("NAMEASCII", "ADM0NAME"))
head(df_coords, n = 10)

```


### Wrangle
#### random sample for labels


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-show'}

sample_labels <- sample_n(df_coords, 25)
sample_labels

```


### Analyze
#### create bin groups by rank, and labels for legend


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-show'}

df_bins <- df_coords %>% mutate(GROUP = ntile(df_coords$Rank, 6))
head(df_bins, n = 10)

df_bin_labels <- df_bins %>%
  group_by(GROUP) %>%
  summarise(
    bmin = min(Rank, na.rm = T),
    bmax = max(Rank, na.rm = T),
    count = n()
  ) %>%
  mutate(label = paste0("[ ", bmin, "-", bmax, " ]"))

# df_bin_labels

```


### Base map
#### natural earth


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source = 'fold-show'}

ne_world <- ne_countries(scale = "small", returnclass = "sf")
ne_world <- filter(ne_world, iso_a3 != "ATA")

```


### View
#### cities, ranks, and labels


```{r, message=FALSE, warning=FALSE, echo=TRUE, class.source='fold-hide', fig.align='center', out.width="100%"}

theme_opts <- theme(
  text = element_text(family = "inconsolata"), 
  plot.title = element_text(color = "black", size = 14, face = "bold", family = "inconsolata"),
  plot.subtitle = element_text(color = "black", size = 12, family = "inconsolata"),
  plot.caption = element_text(color = "#555555", size = 8, family = "inconsolata"),
  plot.background = element_blank(),
  panel.grid = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background=element_rect(fill="white", colour="white"),
  panel.border = element_blank(),
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  axis.title = element_blank(),
  legend.position = "top",
  legend.title = element_blank()
)

bin_palette <- c(
  "1" = "#254055", # most liveable
  "2" = "#7597b4",
  "3" = "#9ac4b8",
  "4" = "#c1cbba",
  "5" = "#e2d0ae",
  "6" = "#dba63b"  # least liveable
)

v1 <- ggplot(data = ne_world) +
  geom_sf(fill="#d9e0e5", color="white", size = 0.5) +
  geom_point( data = df_bins, aes(x=LONGITUDE, y=LATITUDE, fill = as.factor(GROUP)), shape = 21, size = 2, color = "#333333") +
  geom_text_repel(data = sample_labels, aes(x = LONGITUDE, y = LATITUDE, label = paste0(City, " [ ", Rank, " ]")), 
                  size = 4, hjust = 0.5, vjust = 0.5, family = "inconsolata", fontface = "bold",
                  seed = 42, force = 5, force_pull = 0, box.padding = 0.75, min.segment.length = 0, direction = "y", 
                  color = "black", bg.color = "white", bg.r = 0.15) +
  scale_fill_manual(values = bin_palette, labels = df_bin_labels$label) +
  theme_bw() +
  labs(x=NULL,
       y=NULL,
       title = "Quality of Living City Ranking", 
       subtitle="color by rank group") +
  theme_opts

girafe(ggobj = v1, width_svg = 16, height_svg = 8.25,
       options = list(opts_sizing(rescale = TRUE, width = 1.0)))

```


### References
#### Citations and data sources


* Narrative: The Economist, Graphic detail, [GO](https://www.economist.com/graphic-detail/2021/06/08/auckland-has-become-the-worlds-most-liveable-city){target="_blank"} 
* Data: Mercer, Quality of living city ranking 2019, [GO](https://mobilityexchange.mercer.com/insights/quality-of-living-rankings){target="_blank"} 


```{r, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE, class.source='fold-hide'}

# eval = FALSE as default; run manually as chunk
# PUSH TO PRODUCTION
source("../../../z-scripts/create_production_output.R", local = knitr::knit_global())

```



```{js, message=FALSE, warning=FALSE, echo=FALSE}

// Must be included to position footer
$(function() {
  $('.main-container').after($('.footer'));
})

```

